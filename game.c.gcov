        -:    0:Source:/home/dgpt/code/games/micro-idle/game/game.c
        -:    0:Graph:build/CMakeFiles/tests.dir/game/game.c.gcno
        -:    0:Data:build/CMakeFiles/tests.dir/game/game.c.gcda
        -:    0:Runs:9
        -:    1:#include "game/game.h"
        -:    2:
        -:    3:#include <stdlib.h>
        -:    4:#include <string.h>
        -:    5:#include <limits.h>
        -:    6:#include <math.h>
        -:    7:
        -:    8:#include "game/gpu_sim.h"
        -:    9:
        -:   10:typedef struct GameConfig {
        -:   11:    int max_count;
        -:   12:    int spawn_initial;
        -:   13:    int spawn_per_sec;
        -:   14:    float bounds_x;
        -:   15:    float bounds_z;
        -:   16:    float plane_width;
        -:   17:    float plane_height;
        -:   18:} GameConfig;
        -:   19:
        -:   20:typedef struct GameState {
        -:   21:    GpuSim gpu;
        -:   22:    GameConfig config;
        -:   23:    float sim_time;
        -:   24:    float spawn_accum;
        -:   25:    int active_count;
        -:   26:} GameState;
        -:   27:
function parse_env_int called 224 returned 100% blocks executed 100%
      224:   28:static int parse_env_int(const char *name, int fallback) {
      224:   29:    const char *env = getenv(name);
call    0 returned 224
      224:   30:    if (!env || *env == '\0') {
branch  0 taken 152 (fallthrough)
branch  1 taken 72
branch  2 taken 0 (fallthrough)
branch  3 taken 152
       72:   31:        return fallback;
        -:   32:    }
      152:   33:    char *end = NULL;
      152:   34:    long value = strtol(env, &end, 10);
call    0 returned 152
      152:   35:    if (end == env || *end != '\0' || value <= 0 || value > INT_MAX) {
branch  0 taken 143 (fallthrough)
branch  1 taken 9
branch  2 taken 143 (fallthrough)
branch  3 taken 0
branch  4 taken 143 (fallthrough)
branch  5 taken 0
branch  6 taken 0 (fallthrough)
branch  7 taken 143
        9:   36:        return fallback;
        -:   37:    }
      143:   38:    return (int)value;
        -:   39:}
        -:   40:
function parse_env_float called 224 returned 100% blocks executed 100%
      224:   41:static float parse_env_float(const char *name, float fallback) {
      224:   42:    const char *env = getenv(name);
call    0 returned 224
      224:   43:    if (!env || *env == '\0') {
branch  0 taken 108 (fallthrough)
branch  1 taken 116
branch  2 taken 0 (fallthrough)
branch  3 taken 108
      116:   44:        return fallback;
        -:   45:    }
      108:   46:    char *end = NULL;
      108:   47:    float value = strtof(env, &end);
call    0 returned 108
      108:   48:    if (end == env || *end != '\0' || !isfinite(value) || value <= 0.0f) {
branch  0 taken 108 (fallthrough)
branch  1 taken 0
branch  2 taken 108 (fallthrough)
branch  3 taken 0
branch  4 taken 108 (fallthrough)
branch  5 taken 0
branch  6 taken 18 (fallthrough)
branch  7 taken 90
       18:   49:        return fallback;
        -:   50:    }
       90:   51:    return value;
        -:   52:}
        -:   53:
function game_max_entities called 56 returned 100% blocks executed 100%
       56:   54:static int game_max_entities(void) {
       56:   55:    int count = parse_env_int("MICRO_IDLE_ENTITY_COUNT", GAME_GPU_ENTITY_COUNT);
call    0 returned 56
       56:   56:    int cap = parse_env_int("MICRO_IDLE_ENTITY_MAX", count);
call    0 returned 56
       56:   57:    return (cap < count) ? cap : count;
        -:   58:}
        -:   59:
function game_initial_entities called 56 returned 100% blocks executed 100%
       56:   60:static int game_initial_entities(int max_entities) {
       56:   61:    int initial = parse_env_int("MICRO_IDLE_INITIAL_ENTITIES", 100);
call    0 returned 56
       56:   62:    if (initial > max_entities) {
branch  0 taken 9 (fallthrough)
branch  1 taken 47
        9:   63:        initial = max_entities;
        -:   64:    }
       56:   65:    return initial;
        -:   66:}
        -:   67:
function game_spawn_rate called 56 returned 100% blocks executed 100%
       56:   68:static int game_spawn_rate(void) {
       56:   69:    return parse_env_int("MICRO_IDLE_ENTITIES_PER_SEC", 1);
call    0 returned 56
        -:   70:}
        -:   71:
function game_load_config called 56 returned 100% blocks executed 100%
       56:   72:static GameConfig game_load_config(void) {
       56:   73:    GameConfig config = {0};
       56:   74:    config.max_count = game_max_entities();
call    0 returned 56
       56:   75:    config.spawn_initial = game_initial_entities(config.max_count);
call    0 returned 56
       56:   76:    config.spawn_per_sec = game_spawn_rate();
call    0 returned 56
       56:   77:    config.bounds_x = parse_env_float("MICRO_IDLE_BOUNDS_X", 14.0f);
call    0 returned 56
       56:   78:    config.bounds_z = parse_env_float("MICRO_IDLE_BOUNDS_Z", 12.0f);
call    0 returned 56
       56:   79:    config.plane_width = parse_env_float("MICRO_IDLE_PLANE_WIDTH", 30.0f);
call    0 returned 56
       56:   80:    config.plane_height = parse_env_float("MICRO_IDLE_PLANE_HEIGHT", 24.0f);
call    0 returned 56
       56:   81:    return config;
        -:   82:}
        -:   83:
function game_create called 56 returned 100% blocks executed 86%
       56:   84:GameState *game_create(uint64_t seed) {
       56:   85:    GameState *game = (GameState *)malloc(sizeof(GameState));
       56:   86:    if (!game) {
branch  0 taken 0 (fallthrough)
branch  1 taken 56
    #####:   87:        return NULL;
        -:   88:    }
       56:   89:    if (!game_init(game, seed)) {
call    0 returned 56
branch  1 taken 9 (fallthrough)
branch  2 taken 47
        9:   90:        free(game);
        9:   91:        return NULL;
        -:   92:    }
       47:   93:    return game;
        -:   94:}
        -:   95:
function game_destroy called 56 returned 100% blocks executed 100%
       56:   96:void game_destroy(GameState *game) {
       56:   97:    if (!game) {
branch  0 taken 9 (fallthrough)
branch  1 taken 47
        9:   98:        return;
        -:   99:    }
       47:  100:    if (game->gpu.ready) {
branch  0 taken 47 (fallthrough)
branch  1 taken 0
       47:  101:        gpu_sim_shutdown(&game->gpu);
call    0 returned 47
        -:  102:    }
       47:  103:    free(game);
        -:  104:}
        -:  105:
function game_init called 56 returned 100% blocks executed 100%
       56:  106:bool game_init(GameState *game, uint64_t seed) {
        -:  107:    (void)seed;
       56:  108:    memset(game, 0, sizeof(*game));
       56:  109:    game->config = game_load_config();
call    0 returned 56
       56:  110:    game->active_count = game->config.spawn_initial;
       56:  111:    if (!gpu_sim_init(&game->gpu, game->config.max_count)) {
call    0 returned 56
branch  1 taken 9 (fallthrough)
branch  2 taken 47
        9:  112:        return false;
        -:  113:    }
       47:  114:    gpu_sim_set_active_count(&game->gpu, game->active_count);
call    0 returned 47
       47:  115:    return true;
        -:  116:}
        -:  117:
function game_handle_input called 27 returned 100% blocks executed 100%
       27:  118:void game_handle_input(GameState *game, Camera3D camera, float dt, int screen_w, int screen_h) {
        -:  119:    (void)game;
        -:  120:    (void)camera;
        -:  121:    (void)dt;
        -:  122:    (void)screen_w;
        -:  123:    (void)screen_h;
       27:  124:}
        -:  125:
function game_update_fixed called 47 returned 100% blocks executed 100%
       47:  126:void game_update_fixed(GameState *game, float dt) {
       47:  127:    if (!game || !game->gpu.ready) {
branch  0 taken 38 (fallthrough)
branch  1 taken 9
branch  2 taken 0 (fallthrough)
branch  3 taken 38
        9:  128:        return;
        -:  129:    }
       38:  130:    game->sim_time += dt;
       38:  131:    if (game->active_count < game->config.max_count && game->config.spawn_per_sec > 0) {
branch  0 taken 29 (fallthrough)
branch  1 taken 9
branch  2 taken 29 (fallthrough)
branch  3 taken 0
       29:  132:        game->spawn_accum += dt;
       31:  133:        while (game->spawn_accum >= 1.0f && game->active_count < game->config.max_count) {
branch  0 taken 2 (fallthrough)
branch  1 taken 29
branch  2 taken 2
branch  3 taken 0 (fallthrough)
        2:  134:            game->spawn_accum -= 1.0f;
        2:  135:            game->active_count += game->config.spawn_per_sec;
        2:  136:            if (game->active_count > game->config.max_count) {
branch  0 taken 2 (fallthrough)
branch  1 taken 0
        2:  137:                game->active_count = game->config.max_count;
        -:  138:            }
        -:  139:        }
       29:  140:        gpu_sim_set_active_count(&game->gpu, game->active_count);
call    0 returned 29
        -:  141:    }
       38:  142:    gpu_sim_update(&game->gpu, dt, (Vector2){game->config.bounds_x, game->config.bounds_z});
call    0 returned 38
        -:  143:}
        -:  144:
function game_render called 45 returned 100% blocks executed 100%
       45:  145:void game_render(const GameState *game, Camera3D camera, float alpha) {
        -:  146:    (void)alpha;
       45:  147:    if (!game || !game->gpu.ready) {
branch  0 taken 36 (fallthrough)
branch  1 taken 9
branch  2 taken 0 (fallthrough)
branch  3 taken 36
        9:  148:        return;
        -:  149:    }
       36:  150:    BeginMode3D(camera);
call    0 returned 36
       36:  151:    DrawPlane((Vector3){0.0f, -0.2f, 0.0f},
       36:  152:              (Vector2){game->config.plane_width, game->config.plane_height},
       36:  153:              (Color){10, 20, 30, 255});
call    0 returned 36
       36:  154:    gpu_sim_render(&game->gpu, camera);
call    0 returned 36
       36:  155:    EndMode3D();
call    0 returned 36
        -:  156:}
        -:  157:
function game_render_ui called 54 returned 100% blocks executed 100%
       54:  158:void game_render_ui(GameState *game, int screen_w, int screen_h) {
        -:  159:    (void)game;
       54:  160:    DrawRectangle(12, 12, 280, 80, (Color){10, 10, 20, 200});
call    0 returned 54
       54:  161:    DrawText("Micro-Idle (GPU)", 20, 20, 16, RAYWHITE);
call    0 returned 54
       54:  162:    DrawText(TextFormat("Entities: %d", game && game->gpu.ready ? game->gpu.active_count : GAME_GPU_ENTITY_COUNT),
branch  0 taken 27 (fallthrough)
branch  1 taken 0
call    2 returned 54
call    3 returned 54
       54:  163:             20, 42, 12, GRAY);
branch  0 taken 27 (fallthrough)
branch  1 taken 27
       54:  164:    DrawText(TextFormat("Screen: %dx%d", screen_w, screen_h), 20, 60, 12, GRAY);
call    0 returned 54
call    1 returned 54
       54:  165:}
