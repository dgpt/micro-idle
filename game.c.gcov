        -:    0:Source:/home/dgpt/code/games/micro-idle/game/game.c
        -:    0:Graph:build/CMakeFiles/tests.dir/game/game.c.gcno
        -:    0:Data:build/CMakeFiles/tests.dir/game/game.c.gcda
        -:    0:Runs:11
        -:    1:#include "game/game.h"
        -:    2:
        -:    3:#include <stdlib.h>
        -:    4:#include <string.h>
        -:    5:#include <limits.h>
        -:    6:#include <math.h>
        -:    7:
        -:    8:#include "game/gpu_sim.h"
        -:    9:
        -:   10:typedef struct GameConfig {
        -:   11:    int max_count;
        -:   12:    int spawn_initial;
        -:   13:    int spawn_per_sec;
        -:   14:    float bounds_x;
        -:   15:    float bounds_z;
        -:   16:    float plane_width;
        -:   17:    float plane_height;
        -:   18:} GameConfig;
        -:   19:
        -:   20:typedef struct GameState {
        -:   21:    GpuSim gpu;
        -:   22:    GameConfig config;
        -:   23:    float sim_time;
        -:   24:    float spawn_accum;
        -:   25:    int active_count;
        -:   26:} GameState;
        -:   27:
function parse_env_int called 280 returned 100% blocks executed 100%
      280:   28:static int parse_env_int(const char *name, int fallback) {
      280:   29:    const char *env = getenv(name);
call    0 returned 280
      280:   30:    if (!env || *env == '\0') {
branch  0 taken 192 (fallthrough)
branch  1 taken 88
branch  2 taken 0 (fallthrough)
branch  3 taken 192
       88:   31:        return fallback;
        -:   32:    }
      192:   33:    char *end = NULL;
      192:   34:    long value = strtol(env, &end, 10);
call    0 returned 192
      192:   35:    if (end == env || *end != '\0' || value <= 0 || value > INT_MAX) {
branch  0 taken 181 (fallthrough)
branch  1 taken 11
branch  2 taken 181 (fallthrough)
branch  3 taken 0
branch  4 taken 181 (fallthrough)
branch  5 taken 0
branch  6 taken 0 (fallthrough)
branch  7 taken 181
       11:   36:        return fallback;
        -:   37:    }
      181:   38:    return (int)value;
        -:   39:}
        -:   40:
function parse_env_float called 280 returned 100% blocks executed 100%
      280:   41:static float parse_env_float(const char *name, float fallback) {
      280:   42:    const char *env = getenv(name);
call    0 returned 280
      280:   43:    if (!env || *env == '\0') {
branch  0 taken 132 (fallthrough)
branch  1 taken 148
branch  2 taken 0 (fallthrough)
branch  3 taken 132
      148:   44:        return fallback;
        -:   45:    }
      132:   46:    char *end = NULL;
      132:   47:    float value = strtof(env, &end);
call    0 returned 132
      132:   48:    if (end == env || *end != '\0' || !isfinite(value) || value <= 0.0f) {
branch  0 taken 132 (fallthrough)
branch  1 taken 0
branch  2 taken 132 (fallthrough)
branch  3 taken 0
branch  4 taken 132 (fallthrough)
branch  5 taken 0
branch  6 taken 22 (fallthrough)
branch  7 taken 110
       22:   49:        return fallback;
        -:   50:    }
      110:   51:    return value;
        -:   52:}
        -:   53:
function game_max_entities called 70 returned 100% blocks executed 100%
       70:   54:static int game_max_entities(void) {
       70:   55:    int count = parse_env_int("MICRO_IDLE_ENTITY_COUNT", GAME_GPU_ENTITY_COUNT);
call    0 returned 70
       70:   56:    int cap = parse_env_int("MICRO_IDLE_ENTITY_MAX", count);
call    0 returned 70
       70:   57:    return (cap < count) ? cap : count;
        -:   58:}
        -:   59:
function game_initial_entities called 70 returned 100% blocks executed 100%
       70:   60:static int game_initial_entities(int max_entities) {
       70:   61:    int initial = parse_env_int("MICRO_IDLE_INITIAL_ENTITIES", 100);
call    0 returned 70
       70:   62:    if (initial > max_entities) {
branch  0 taken 11 (fallthrough)
branch  1 taken 59
       11:   63:        initial = max_entities;
        -:   64:    }
       70:   65:    return initial;
        -:   66:}
        -:   67:
function game_spawn_rate called 70 returned 100% blocks executed 100%
       70:   68:static int game_spawn_rate(void) {
       70:   69:    return parse_env_int("MICRO_IDLE_ENTITIES_PER_SEC", 1);
call    0 returned 70
        -:   70:}
        -:   71:
function game_load_config called 70 returned 100% blocks executed 100%
       70:   72:static GameConfig game_load_config(void) {
       70:   73:    GameConfig config = {0};
       70:   74:    config.max_count = game_max_entities();
call    0 returned 70
       70:   75:    config.spawn_initial = game_initial_entities(config.max_count);
call    0 returned 70
       70:   76:    config.spawn_per_sec = game_spawn_rate();
call    0 returned 70
       70:   77:    config.bounds_x = parse_env_float("MICRO_IDLE_BOUNDS_X", 14.0f);
call    0 returned 70
       70:   78:    config.bounds_z = parse_env_float("MICRO_IDLE_BOUNDS_Z", 12.0f);
call    0 returned 70
       70:   79:    config.plane_width = parse_env_float("MICRO_IDLE_PLANE_WIDTH", 30.0f);
call    0 returned 70
       70:   80:    config.plane_height = parse_env_float("MICRO_IDLE_PLANE_HEIGHT", 24.0f);
call    0 returned 70
       70:   81:    return config;
        -:   82:}
        -:   83:
function game_create called 70 returned 100% blocks executed 86%
       70:   84:GameState *game_create(uint64_t seed) {
       70:   85:    GameState *game = (GameState *)malloc(sizeof(GameState));
       70:   86:    if (!game) {
branch  0 taken 0 (fallthrough)
branch  1 taken 70
    #####:   87:        return NULL;
        -:   88:    }
       70:   89:    if (!game_init(game, seed)) {
call    0 returned 70
branch  1 taken 11 (fallthrough)
branch  2 taken 59
       11:   90:        free(game);
       11:   91:        return NULL;
        -:   92:    }
       59:   93:    return game;
        -:   94:}
        -:   95:
function game_destroy called 70 returned 100% blocks executed 100%
       70:   96:void game_destroy(GameState *game) {
       70:   97:    if (!game) {
branch  0 taken 11 (fallthrough)
branch  1 taken 59
       11:   98:        return;
        -:   99:    }
       59:  100:    if (game->gpu.ready) {
branch  0 taken 59 (fallthrough)
branch  1 taken 0
       59:  101:        gpu_sim_shutdown(&game->gpu);
call    0 returned 59
        -:  102:    }
       59:  103:    free(game);
        -:  104:}
        -:  105:
function game_init called 70 returned 100% blocks executed 100%
       70:  106:bool game_init(GameState *game, uint64_t seed) {
        -:  107:    (void)seed;
       70:  108:    memset(game, 0, sizeof(*game));
       70:  109:    game->config = game_load_config();
call    0 returned 70
       70:  110:    game->active_count = game->config.spawn_initial;
       70:  111:    if (!gpu_sim_init(&game->gpu, game->config.max_count)) {
call    0 returned 70
branch  1 taken 11 (fallthrough)
branch  2 taken 59
       11:  112:        return false;
        -:  113:    }
       59:  114:    gpu_sim_set_active_count(&game->gpu, game->active_count);
call    0 returned 59
       59:  115:    return true;
        -:  116:}
        -:  117:
function game_handle_input called 33 returned 100% blocks executed 100%
       33:  118:void game_handle_input(GameState *game, Camera3D camera, float dt, int screen_w, int screen_h) {
        -:  119:    (void)game;
        -:  120:    (void)camera;
        -:  121:    (void)dt;
        -:  122:    (void)screen_w;
        -:  123:    (void)screen_h;
       33:  124:}
        -:  125:
function game_update_fixed called 59 returned 100% blocks executed 100%
       59:  126:void game_update_fixed(GameState *game, float dt) {
       59:  127:    if (!game || !game->gpu.ready) {
branch  0 taken 48 (fallthrough)
branch  1 taken 11
branch  2 taken 0 (fallthrough)
branch  3 taken 48
       11:  128:        return;
        -:  129:    }
       48:  130:    game->sim_time += dt;
       48:  131:    if (game->active_count < game->config.max_count && game->config.spawn_per_sec > 0) {
branch  0 taken 37 (fallthrough)
branch  1 taken 11
branch  2 taken 37 (fallthrough)
branch  3 taken 0
       37:  132:        game->spawn_accum += dt;
       41:  133:        while (game->spawn_accum >= 1.0f && game->active_count < game->config.max_count) {
branch  0 taken 4 (fallthrough)
branch  1 taken 37
branch  2 taken 4
branch  3 taken 0 (fallthrough)
        4:  134:            game->spawn_accum -= 1.0f;
        4:  135:            game->active_count += game->config.spawn_per_sec;
        4:  136:            if (game->active_count > game->config.max_count) {
branch  0 taken 4 (fallthrough)
branch  1 taken 0
        4:  137:                game->active_count = game->config.max_count;
        -:  138:            }
        -:  139:        }
       37:  140:        gpu_sim_set_active_count(&game->gpu, game->active_count);
call    0 returned 37
        -:  141:    }
       48:  142:    gpu_sim_update(&game->gpu, dt, (Vector2){game->config.bounds_x, game->config.bounds_z});
call    0 returned 48
        -:  143:}
        -:  144:
function game_render called 55 returned 100% blocks executed 100%
       55:  145:void game_render(const GameState *game, Camera3D camera, float alpha) {
        -:  146:    (void)alpha;
       55:  147:    if (!game || !game->gpu.ready) {
branch  0 taken 44 (fallthrough)
branch  1 taken 11
branch  2 taken 0 (fallthrough)
branch  3 taken 44
       11:  148:        return;
        -:  149:    }
       44:  150:    BeginMode3D(camera);
call    0 returned 44
       44:  151:    DrawPlane((Vector3){0.0f, -0.2f, 0.0f},
       44:  152:              (Vector2){game->config.plane_width, game->config.plane_height},
       44:  153:              (Color){10, 20, 30, 255});
call    0 returned 44
       44:  154:    gpu_sim_render(&game->gpu, camera);
call    0 returned 44
       44:  155:    EndMode3D();
call    0 returned 44
        -:  156:}
        -:  157:
function game_render_ui called 66 returned 100% blocks executed 100%
       66:  158:void game_render_ui(GameState *game, int screen_w, int screen_h) {
        -:  159:    (void)game;
       66:  160:    DrawRectangle(12, 12, 280, 80, (Color){10, 10, 20, 200});
call    0 returned 66
       66:  161:    DrawText("Micro-Idle (GPU)", 20, 20, 16, RAYWHITE);
call    0 returned 66
       66:  162:    DrawText(TextFormat("Entities: %d", game && game->gpu.ready ? game->gpu.active_count : GAME_GPU_ENTITY_COUNT),
branch  0 taken 33 (fallthrough)
branch  1 taken 0
call    2 returned 66
call    3 returned 66
       66:  163:             20, 42, 12, GRAY);
branch  0 taken 33 (fallthrough)
branch  1 taken 33
       66:  164:    DrawText(TextFormat("Screen: %dx%d", screen_w, screen_h), 20, 60, 12, GRAY);
call    0 returned 66
call    1 returned 66
       66:  165:}
