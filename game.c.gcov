        -:    0:Source:/home/dgpt/code/games/micro-idle/game/game.c
        -:    0:Graph:build/CMakeFiles/tests.dir/game/game.c.gcno
        -:    0:Data:build/CMakeFiles/tests.dir/game/game.c.gcda
        -:    0:Runs:13
        -:    1:#include "game/game.h"
        -:    2:
        -:    3:#include <stdlib.h>
        -:    4:#include <string.h>
        -:    5:#include <limits.h>
        -:    6:#include <math.h>
        -:    7:
        -:    8:#include "game/gpu_sim.h"
        -:    9:
        -:   10:typedef struct GameConfig {
        -:   11:    int max_count;
        -:   12:    int spawn_initial;
        -:   13:    int spawn_per_sec;
        -:   14:    float bounds_x;
        -:   15:    float bounds_z;
        -:   16:    float plane_width;
        -:   17:    float plane_height;
        -:   18:} GameConfig;
        -:   19:
        -:   20:typedef struct GameState {
        -:   21:    GpuSim gpu;
        -:   22:    GameConfig config;
        -:   23:    float sim_time;
        -:   24:    float spawn_accum;
        -:   25:    int active_count;
        -:   26:} GameState;
        -:   27:
function parse_env_int called 336 returned 100% blocks executed 100%
      336:   28:static int parse_env_int(const char *name, int fallback) {
      336:   29:    const char *env = getenv(name);
call    0 returned 336
      336:   30:    if (!env || *env == '\0') {
branch  0 taken 232 (fallthrough)
branch  1 taken 104
branch  2 taken 0 (fallthrough)
branch  3 taken 232
      104:   31:        return fallback;
        -:   32:    }
      232:   33:    char *end = NULL;
      232:   34:    long value = strtol(env, &end, 10);
call    0 returned 232
      232:   35:    if (end == env || *end != '\0' || value <= 0 || value > INT_MAX) {
branch  0 taken 219 (fallthrough)
branch  1 taken 13
branch  2 taken 219 (fallthrough)
branch  3 taken 0
branch  4 taken 219 (fallthrough)
branch  5 taken 0
branch  6 taken 0 (fallthrough)
branch  7 taken 219
       13:   36:        return fallback;
        -:   37:    }
      219:   38:    return (int)value;
        -:   39:}
        -:   40:
function parse_env_float called 336 returned 100% blocks executed 100%
      336:   41:static float parse_env_float(const char *name, float fallback) {
      336:   42:    const char *env = getenv(name);
call    0 returned 336
      336:   43:    if (!env || *env == '\0') {
branch  0 taken 156 (fallthrough)
branch  1 taken 180
branch  2 taken 0 (fallthrough)
branch  3 taken 156
      180:   44:        return fallback;
        -:   45:    }
      156:   46:    char *end = NULL;
      156:   47:    float value = strtof(env, &end);
call    0 returned 156
      156:   48:    if (end == env || *end != '\0' || !isfinite(value) || value <= 0.0f) {
branch  0 taken 156 (fallthrough)
branch  1 taken 0
branch  2 taken 156 (fallthrough)
branch  3 taken 0
branch  4 taken 156 (fallthrough)
branch  5 taken 0
branch  6 taken 26 (fallthrough)
branch  7 taken 130
       26:   49:        return fallback;
        -:   50:    }
      130:   51:    return value;
        -:   52:}
        -:   53:
function game_max_entities called 84 returned 100% blocks executed 100%
       84:   54:static int game_max_entities(void) {
       84:   55:    int count = parse_env_int("MICRO_IDLE_ENTITY_COUNT", GAME_GPU_ENTITY_COUNT);
call    0 returned 84
       84:   56:    int cap = parse_env_int("MICRO_IDLE_ENTITY_MAX", count);
call    0 returned 84
       84:   57:    return (cap < count) ? cap : count;
        -:   58:}
        -:   59:
function game_initial_entities called 84 returned 100% blocks executed 100%
       84:   60:static int game_initial_entities(int max_entities) {
       84:   61:    int initial = parse_env_int("MICRO_IDLE_INITIAL_ENTITIES", 100);
call    0 returned 84
       84:   62:    if (initial > max_entities) {
branch  0 taken 13 (fallthrough)
branch  1 taken 71
       13:   63:        initial = max_entities;
        -:   64:    }
       84:   65:    return initial;
        -:   66:}
        -:   67:
function game_spawn_rate called 84 returned 100% blocks executed 100%
       84:   68:static int game_spawn_rate(void) {
       84:   69:    return parse_env_int("MICRO_IDLE_ENTITIES_PER_SEC", 1);
call    0 returned 84
        -:   70:}
        -:   71:
function game_load_config called 84 returned 100% blocks executed 100%
       84:   72:static GameConfig game_load_config(void) {
       84:   73:    GameConfig config = {0};
       84:   74:    config.max_count = game_max_entities();
call    0 returned 84
       84:   75:    config.spawn_initial = game_initial_entities(config.max_count);
call    0 returned 84
       84:   76:    config.spawn_per_sec = game_spawn_rate();
call    0 returned 84
       84:   77:    config.bounds_x = parse_env_float("MICRO_IDLE_BOUNDS_X", 14.0f);
call    0 returned 84
       84:   78:    config.bounds_z = parse_env_float("MICRO_IDLE_BOUNDS_Z", 12.0f);
call    0 returned 84
       84:   79:    config.plane_width = parse_env_float("MICRO_IDLE_PLANE_WIDTH", 30.0f);
call    0 returned 84
       84:   80:    config.plane_height = parse_env_float("MICRO_IDLE_PLANE_HEIGHT", 24.0f);
call    0 returned 84
       84:   81:    return config;
        -:   82:}
        -:   83:
function game_create called 84 returned 100% blocks executed 86%
       84:   84:GameState *game_create(uint64_t seed) {
       84:   85:    GameState *game = (GameState *)malloc(sizeof(GameState));
       84:   86:    if (!game) {
branch  0 taken 0 (fallthrough)
branch  1 taken 84
    #####:   87:        return NULL;
        -:   88:    }
       84:   89:    if (!game_init(game, seed)) {
call    0 returned 84
branch  1 taken 13 (fallthrough)
branch  2 taken 71
       13:   90:        free(game);
       13:   91:        return NULL;
        -:   92:    }
       71:   93:    return game;
        -:   94:}
        -:   95:
function game_destroy called 84 returned 100% blocks executed 100%
       84:   96:void game_destroy(GameState *game) {
       84:   97:    if (!game) {
branch  0 taken 13 (fallthrough)
branch  1 taken 71
       13:   98:        return;
        -:   99:    }
       71:  100:    if (game->gpu.ready) {
branch  0 taken 71 (fallthrough)
branch  1 taken 0
       71:  101:        gpu_sim_shutdown(&game->gpu);
call    0 returned 71
        -:  102:    }
       71:  103:    free(game);
        -:  104:}
        -:  105:
function game_init called 84 returned 100% blocks executed 100%
       84:  106:bool game_init(GameState *game, uint64_t seed) {
        -:  107:    (void)seed;
       84:  108:    memset(game, 0, sizeof(*game));
       84:  109:    game->config = game_load_config();
call    0 returned 84
       84:  110:    game->active_count = game->config.spawn_initial;
       84:  111:    if (!gpu_sim_init(&game->gpu, game->config.max_count)) {
call    0 returned 84
branch  1 taken 13 (fallthrough)
branch  2 taken 71
       13:  112:        return false;
        -:  113:    }
       71:  114:    gpu_sim_set_active_count(&game->gpu, game->active_count);
call    0 returned 71
       71:  115:    return true;
        -:  116:}
        -:  117:
function game_handle_input called 39 returned 100% blocks executed 100%
       39:  118:void game_handle_input(GameState *game, Camera3D camera, float dt, int screen_w, int screen_h) {
        -:  119:    (void)game;
        -:  120:    (void)camera;
        -:  121:    (void)dt;
        -:  122:    (void)screen_w;
        -:  123:    (void)screen_h;
       39:  124:}
        -:  125:
function game_update_fixed called 71 returned 100% blocks executed 100%
       71:  126:void game_update_fixed(GameState *game, float dt) {
       71:  127:    if (!game || !game->gpu.ready) {
branch  0 taken 58 (fallthrough)
branch  1 taken 13
branch  2 taken 0 (fallthrough)
branch  3 taken 58
       13:  128:        return;
        -:  129:    }
       58:  130:    game->sim_time += dt;
       58:  131:    if (game->active_count < game->config.max_count && game->config.spawn_per_sec > 0) {
branch  0 taken 45 (fallthrough)
branch  1 taken 13
branch  2 taken 45 (fallthrough)
branch  3 taken 0
       45:  132:        game->spawn_accum += dt;
       51:  133:        while (game->spawn_accum >= 1.0f && game->active_count < game->config.max_count) {
branch  0 taken 6 (fallthrough)
branch  1 taken 45
branch  2 taken 6
branch  3 taken 0 (fallthrough)
        6:  134:            game->spawn_accum -= 1.0f;
        6:  135:            game->active_count += game->config.spawn_per_sec;
        6:  136:            if (game->active_count > game->config.max_count) {
branch  0 taken 6 (fallthrough)
branch  1 taken 0
        6:  137:                game->active_count = game->config.max_count;
        -:  138:            }
        -:  139:        }
       45:  140:        gpu_sim_set_active_count(&game->gpu, game->active_count);
call    0 returned 45
        -:  141:    }
       58:  142:    gpu_sim_update(&game->gpu, dt, (Vector2){game->config.bounds_x, game->config.bounds_z});
call    0 returned 58
        -:  143:}
        -:  144:
function game_render called 65 returned 100% blocks executed 100%
       65:  145:void game_render(const GameState *game, Camera3D camera, float alpha) {
        -:  146:    (void)alpha;
       65:  147:    if (!game || !game->gpu.ready) {
branch  0 taken 52 (fallthrough)
branch  1 taken 13
branch  2 taken 0 (fallthrough)
branch  3 taken 52
       13:  148:        return;
        -:  149:    }
       52:  150:    BeginMode3D(camera);
call    0 returned 52
       52:  151:    DrawPlane((Vector3){0.0f, -0.2f, 0.0f},
       52:  152:              (Vector2){game->config.plane_width, game->config.plane_height},
       52:  153:              (Color){10, 20, 30, 255});
call    0 returned 52
       52:  154:    gpu_sim_render(&game->gpu, camera);
call    0 returned 52
       52:  155:    EndMode3D();
call    0 returned 52
        -:  156:}
        -:  157:
function game_render_ui called 78 returned 100% blocks executed 100%
       78:  158:void game_render_ui(GameState *game, int screen_w, int screen_h) {
        -:  159:    (void)game;
       78:  160:    DrawRectangle(12, 12, 280, 80, (Color){10, 10, 20, 200});
call    0 returned 78
       78:  161:    DrawText("Micro-Idle (GPU)", 20, 20, 16, RAYWHITE);
call    0 returned 78
       78:  162:    DrawText(TextFormat("Entities: %d", game && game->gpu.ready ? game->gpu.active_count : GAME_GPU_ENTITY_COUNT),
branch  0 taken 39 (fallthrough)
branch  1 taken 0
call    2 returned 78
call    3 returned 78
       78:  163:             20, 42, 12, GRAY);
branch  0 taken 39 (fallthrough)
branch  1 taken 39
       78:  164:    DrawText(TextFormat("Screen: %dx%d", screen_w, screen_h), 20, 60, 12, GRAY);
call    0 returned 78
call    1 returned 78
       78:  165:}
