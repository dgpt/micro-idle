#version 430 core

// XPBD Step 1: Predict positions
// Apply external forces and predict new positions using symplectic Euler integration.

layout(local_size_x = 256) in;

struct Particle {
    vec4 pos;       // xyz position, w = inverse mass
    vec4 pos_prev;  // previous position
    vec4 vel;       // xyz velocity, w = microbe_id
    vec4 data;      // x = particle_index, y = constraint_start, z = constraint_count
};

layout(std430, binding = 0) buffer Particles { Particle particles[]; };

uniform float u_dt;
uniform int u_particle_count;

void main() {
    uint idx = gl_GlobalInvocationID.x;
    if (idx >= uint(u_particle_count)) return;

    Particle p = particles[idx];
    float inv_mass = p.pos.w;

    // Skip fixed particles (inv_mass == 0)
    if (inv_mass < 0.0001) return;

    // Store previous position for velocity derivation later
    p.pos_prev.xyz = p.pos.xyz;

    // Apply velocity (no gravity for top-down 2D microbes)
    // Small damping for stability
    p.vel.xyz *= 0.995;

    // Predict new position
    p.pos.xyz += p.vel.xyz * u_dt;

    particles[idx] = p;
}
