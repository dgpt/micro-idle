#version 430 core

// Bounds enforcement: Keep microbes within screen bounds with bouncing

layout(local_size_x = 64) in;

struct Particle {
    vec4 pos;       // xyz position, w = inverse mass
    vec4 pos_prev;  // previous position
    vec4 vel;       // xyz velocity, w = microbe_id
    vec4 data;
};

struct Microbe {
    vec4 center;    // xyz center, w = radius
    vec4 color;
    vec4 params;    // x = type, y = stiffness, z = seed, w = squish
    vec4 aabb;
};

layout(std430, binding = 0) buffer Particles { Particle particles[]; };
layout(std430, binding = 1) buffer Microbes { Microbe microbes[]; };

uniform int u_microbe_count;
uniform int u_particles_per_microbe;
uniform vec2 u_bounds;  // Half-width, half-height

void main() {
    uint microbe_id = gl_GlobalInvocationID.x;
    if (microbe_id >= uint(u_microbe_count)) return;

    Microbe m = microbes[microbe_id];
    vec3 center = m.center.xyz;
    vec3 correction = vec3(0.0);
    bool bounced = false;

    // Check X bounds
    if (center.x < -u_bounds.x) {
        correction.x = -u_bounds.x - center.x;
        bounced = true;
    } else if (center.x > u_bounds.x) {
        correction.x = u_bounds.x - center.x;
        bounced = true;
    }

    // Check Z bounds
    if (center.z < -u_bounds.y) {
        correction.z = -u_bounds.y - center.z;
        bounced = true;
    } else if (center.z > u_bounds.y) {
        correction.z = u_bounds.y - center.z;
        bounced = true;
    }

    // Apply correction to all particles in this microbe
    if (bounced) {
        int particle_start = int(microbe_id) * u_particles_per_microbe;

        for (int i = 0; i < u_particles_per_microbe; i++) {
            int idx = particle_start + i;
            particles[idx].pos.xyz += correction;

            // Reverse velocity component that caused collision (bounce)
            if (correction.x != 0.0) {
                particles[idx].vel.x *= -0.7;  // Bounce with energy loss
            }
            if (correction.z != 0.0) {
                particles[idx].vel.z *= -0.7;
            }
        }

        // Update microbe center
        microbes[microbe_id].center.xyz = center + correction;
    }
}
