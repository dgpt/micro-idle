#version 430 core

// Finalize: Update velocities from position changes
// Simple pure function: v = (x - x_prev) / dt

layout(local_size_x = 256) in;

struct Particle {
    vec4 pos;       // xyz position, w = inverse mass
    vec4 pos_prev;  // previous position
    vec4 vel;       // xyz velocity, w = microbe_id
    vec4 data;
};

layout(std430, binding = 0) buffer Particles { Particle particles[]; };

uniform float u_dt;
uniform int u_particle_count;

void main() {
    uint idx = gl_GlobalInvocationID.x;
    if (idx >= uint(u_particle_count)) return;

    Particle p = particles[idx];
    const float inv_mass = p.pos.w;

    // Pure computation: velocity from position delta
    if (inv_mass > 0.0001 && u_dt > 0.0001) {
        particles[idx].vel.xyz = (p.pos.xyz - p.pos_prev.xyz) / u_dt;
    }
}
